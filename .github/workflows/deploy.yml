name: Deploy to Production

on:
  workflow_dispatch:
 
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # Requires approval if configured in GitHub settings

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DO_USER }}@${{ secrets.DO_HOST }} << 'ENDSSH'
            set -e
            
            cd /root/pawradise-inn

            echo "üîπ Pulling latest code..."
            git fetch origin main
            git checkout main
            git reset --hard origin/main

            echo "üîπ Creating config directories..."
            mkdir -p ./backend/config
            mkdir -p ./frontend/config

            echo "üîπ Writing backend config..."
            cat > ./backend/config/config.env << 'ENDBACKEND'
PORT=${{ secrets.PORT }}
NODE_ENV=${{ secrets.NODE_ENV }}
DATABASE_URL=${{ secrets.DATABASE_URL }}
JWT_SECRET=${{ secrets.JWT_SECRET }}
JWT_EXPIRE=${{ secrets.JWT_EXPIRE }}
JWT_COOKIE_EXPIRE=${{ secrets.JWT_COOKIE_EXPIRE }}
ENDBACKEND

            echo "üîπ Writing frontend config..."
            cat > ./frontend/config/config.env << 'ENDFRONTEND'
VITE_BRANCH_ID=${{ secrets.VITE_BRANCH_ID }}
VITE_API_KEY=${{ secrets.VITE_API_KEY }}
ENDFRONTEND

            echo "üîπ Writing keyfile.json..."
            cat > ./backend/config/keyfile.json << 'ENDKEYFILE'
${{ secrets.GOOGLE_KEYFILE_JSON }}
ENDKEYFILE

            echo "üîπ Setting proper permissions..."
            chmod 600 ./backend/config/config.env
            chmod 600 ./frontend/config/config.env
            chmod 600 ./backend/config/keyfile.json

            echo "üîπ Stopping old containers..."
            npm run prod:down || true

            echo "üîπ Cleaning up old images..."
            docker image prune -f || true

            echo "üîπ Building and starting containers..."
            npm run prod:up

            echo "üîπ Waiting for services to start..."
            sleep 10

            echo "üîπ Checking container status..."
            docker ps

            echo "üîπ Checking backend health..."
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "‚úÖ Backend is healthy"
            else
              echo "‚ö†Ô∏è Backend health check failed (might be normal if no /health endpoint)"
            fi

            echo "‚úÖ Deployment complete!"
          ENDSSH

      - name: Notify on Success
        if: success()
        run: echo "üéâ Deployment to production succeeded!"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          exit 1
